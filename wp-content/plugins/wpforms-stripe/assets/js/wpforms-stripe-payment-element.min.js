"use strict";var WPFormsStripePaymentElement=window.WPFormsStripePaymentElement||function(e,o,l){let m,d={stripe:null,elements:null,paymentElement:null,elementsModified:!1,linkElement:null,linkDestroyed:!1,paymentType:"",lockedPageToSwitch:0,paymentMethodId:"",total:"",init:function(){d.stripe=Stripe(wpforms_stripe.publishable_key,{locale:wpforms_stripe.data.element_locale,betas:["elements_enable_deferred_intent_beta_1"]}),l(e).on("wpformsReady",function(){l(".wpforms-stripe form").each(d.setupStripeForm)}),l(e).on("wpformsBeforePageChange",d.pageChange).on("wpformsAmountTotalCalculated",d.updateElementsTotalAmount).on("wpformsProcessConditionalsField",function(e,t,n,i,o){d.processConditionalsField(t,n,i,o)})},setupStripeForm:function(){var e,t=l(this),n=t.find(".wpforms-field-stripe-credit-card");n.find(".wpforms-field-row").length&&(e=t.data("validator"))&&(m=e.settings.submitHandler,e.settings.submitHandler=d.submitHandler,t.on("wpformsAjaxSubmitActionRequired",d.confirmPaymentActionCallback),n.hasClass("wpforms-conditional-field")||d.setupPaymentElement(t))},confirmPaymentActionCallback:async function(e,t){if(t.success&&t.data.action_required){const i=l(this);var n=new URL(o.location.href);await d.stripe.confirmPayment({clientSecret:t.data.payment_intent_client_secret,confirmParams:{return_url:n.toString(),payment_method:d.paymentMethodId},redirect:"if_required"}).then(function(e){d.handleConfirmPayment(i,e)})}},handleConfirmPayment:function(e,t){t.error?d.displayStripeError(e,t.error.message):t.paymentIntent&&"succeeded"===t.paymentIntent.status?(e.find(".wpforms-stripe-payment-method-id").remove(),e.find(".wpforms-stripe-payment-intent-id").remove(),e.append('<input type="hidden" class="wpforms-stripe-payment-intent-id" name="wpforms[payment_intent_id]" value="'+t.paymentIntent.id+'">'),wpforms.formSubmitAjax(e)):d.formAjaxUnblock(e)},setupPaymentElement:function(e){d.paymentElement||(d.elements=d.stripe.elements({currency:wpforms.getCurrency().code.toLowerCase(),mode:"payment",amount:1e3,loader:"always",locale:wpforms_stripe.data.element_locale,appearance:d.getElementAppearanceOptions(e),payment_method_types:["card","link"]}),d.initializePaymentElement(e),d.linkEmailMappedFieldTriggers(e),wpforms.amountTotalCalc(e))},processConditionalsField:function(e,t,n,i){var e=l("#wpforms-form-"+e),o=e.find(".wpforms-field-stripe-credit-card");!d.paymentElement&&o.data("field-id").toString()===t&&n&&"hide"!==i&&d.setupPaymentElement(e)},getElementAppearanceOptions:function(e){var t,n;return"object"==typeof o.wpformsStripePaymentElementAppearance?o.wpformsStripePaymentElementAppearance:(t=e.find(".wpforms-stripe-credit-card-hidden-input"),n=!(e=e.find(".wpforms-field-stripe-credit-card .wpforms-field-row")).hasClass("wpforms-sublabel-hide"),{theme:"none",labels:e.data("sublabel-position"),variables:{colorPrimary:t.css("color"),colorBackground:t.css("background-color"),colorText:t.css("color"),colorDanger:"#990000",fontFamily:t.css("font-family"),spacingUnit:"4px",spacingGridRow:"8px",fontSizeSm:"13px",fontWeightNormal:"400",borderRadius:t.css("border-radius")},rules:{".Input--invalid":{color:t.css("color"),borderColor:"#cc0000"},".Input":{border:"1px solid "+t.css("border-color"),borderRadius:t.css("border-radius"),boxShadow:"none",fontSize:t.css("font-size"),padding:"6px 10px",lineHeight:"24px",transition:"none"},".Input:focus":{border:"1px solid #999",boxShadow:"none",outline:"none"},".Label":{fontFamily:t.css("font-family"),lineHeight:"1.3",opacity:Number(n),color:"#000000"},".CheckboxInput, .CodeInput, .PickerItem":{border:"1px solid "+t.css("border-color")},".Tab, .Block":{border:"1px solid "+t.css("border-color"),borderRadius:t.css("border-radius")},".Tab--selected":{borderColor:"#999999"},".Action":{marginLeft:"6px"},".Action, .MenuAction":{border:"none",backgroundColor:"transparent"},".Action:hover, .MenuAction:hover":{border:"none",backgroundColor:"transparent"}}})},initializePaymentElement:function(t,e=""){const n=t.find(".wpforms-field-stripe-credit-card .wpforms-field-row");d.paymentElement&&d.paymentElement.destroy(),d.paymentElement=d.elements.create("payment",{defaultValues:{billingDetails:{email:e}}}),d.mountPaymentElement(t),d.paymentElement.on("change",function(e){d.paymentType=e.value.type,n.data("link-email")||("google_pay"===e.value.type||"apple_pay"===e.value.type?(d.linkElement.destroy(),d.linkDestroyed=!0):d.linkDestroyed&&(d.initializeLinkAuthenticationElement(t),d.linkDestroyed=!1)),n.data("type",e.value.type),n.find("label.wpforms-error").toggle("card"===e.value.type),!e.empty&&(d.elementsModified=!0,e.complete)?n.data("completed",!0):n.data("completed",!1)})},mountPaymentElement:function(e){e="#wpforms-field-stripe-payment-element-"+e.data("formid");d.paymentElement.mount(e)},linkEmailMappedFieldTriggers:function(e){const t=e.find(".wpforms-field-stripe-credit-card .wpforms-field-row");var n=e.data("formid"),i=t.data("link-email");i?l(`#wpforms-${n}-field_`+i).on("change",function(){t.data("completed")||d.initializePaymentElement(e,l(this).val())}):(t.data("linkCompleted",!1),d.initializeLinkAuthenticationElement(e))},initializeLinkAuthenticationElement:function(e){const t=e.find(".wpforms-field-stripe-credit-card .wpforms-field-row");d.linkElement=d.elements.create("linkAuthentication"),d.mountLinkElement(e),d.linkElement.on("change",function(e){e.empty||(d.elementsModified=!0,e.complete?t.data("linkCompleted",!0):t.data("linkCompleted",!1))})},mountLinkElement:function(e){e="#wpforms-field-stripe-link-element-"+e.data("formid");d.linkElement.mount(e)},submitHandler:function(e){var e=l(e),t=e.find(".wpforms-field-stripe-credit-card"),n=t.find(".wpforms-field-row");let i=e.validate().form(),o=n.data("required"),r=!n.data("link-email")&&d.elementsModified||n.data("completed"),a=!1;t.hasClass("wpforms-conditional-hide")||(a=o||r&&!o),i&&a?(e.find(".wpforms-submit").prop("disabled",!0),e.find(".wpforms-submit-spinner").show(),d.createPaymentMethod(e)):i?m(e):(e.find(".wpforms-submit").prop("disabled",!1),e.validate().cancelSubmit=!0)},updateElementsTotalAmount:function(e,t,n){var i=wpforms.getCurrency();(d.total=n)&&d.elements.update({amount:parseInt(wpforms.numberFormat(n,i.decimals,"",""),10)})},createPaymentMethod:async function(t){d.total?await d.stripe.createPaymentMethod({elements:d.elements}).then(function(e){e.error?d.displayStripeFieldError(t,e.error.message):(d.paymentMethodId=e.paymentMethod.id,t.append('<input type="hidden" class="wpforms-stripe-payment-method-id" name="wpforms[payment_method_id]" value="'+d.paymentMethodId+'">'),m(t))}):m(t)},formAjaxUnblock:function(e){var t=e.find(".wpforms-submit"),n=t.data("submit-text");n&&t.text(n),t.prop("disabled",!1),e.closest(".wpforms-container").css("opacity",""),e.find(".wpforms-submit-spinner").hide()},displayStripeError:function(e,t){wpforms.clearFormAjaxGeneralErrors(e),wpforms.displayFormAjaxErrors(e,t),d.formAjaxUnblock(e)},displayStripeFieldError:function(e,t){var n={};n[e.find(".wpforms-stripe-credit-card-hidden-input").attr("name")]=t,wpforms.displayFormAjaxFieldErrors(e,n),d.formAjaxUnblock(e)},pageChange:function(e,t,n,i){var o;"card"!==d.paymentType||(o=n.find(".wpforms-field-stripe-credit-card .wpforms-field-row"),d.elementsModified||(d.paymentElement.unmount(),d.mountPaymentElement(n),o.data("link-email"))||(d.linkElement.unmount(),d.mountLinkElement(n)),!o.is(":visible"))||!o.data("required")&&!d.elementsModified||d.lockedPageToSwitch&&d.lockedPageToSwitch!==t||"prev"===i||(i=void 0===o.data("linkCompleted")||o.data("linkCompleted"),o.data("completed")&&i?o.find(".wpforms-error").hide():(d.lockedPageToSwitch=t,d.displayStripeFieldError(n,wpforms_stripe.i18n.empty_details),e.preventDefault()))}};return d}(document,window,jQuery);WPFormsStripePaymentElement.init();